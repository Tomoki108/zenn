---
title: "実用性を考えたKtorのAuto-reload設定"
emoji: "🔁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ktor", "docker", "docker-compose"]
published: false
---

# 概要
次の職場でKtorを使う予定なので少し触ったところ、[Auto-reload](https://ktor.io/docs/server-development-mode.html#system-property)（ホットリロード）の設定に苦労したので、そのまとめです。 以下の前提で実用的な設定方法を考えてみました。

- KtorアプリケーションはDockerコンテナで実行される
- ローカル開発環境ではDocker Composeで複数のコンテナを起動する
- 当然ローカル開発環境でのみAuto-reloadを有効にする

# 結論

- 開発環境のDockerfile.devを用意する 
- Auto-reloadを有効にしてアプリを起動する
  ```Dockerfile
  ENTRYPOINT ["bash", "-c", "./gradlew -t build & ./gradlew run -t -Dio.ktor.development=true"]
  ```
- compose.ymlでDockerfile.devを指定してサービスを起動する

## レポジトリ
https://github.com/Tomoki108/ktor-sample

# 解説

## Development mode
Auto-reloadを有効にするにはKtorを[Development mode](https://ktor.io/docs/server-development-mode.html)で起動する必要があり、リンクに記載の通り3つの方法があります。

1. Ktorの設定ファイル（application.conf/application.yaml）で設定
2. Gradleの設定ファイル（build.gradle.kts）で設定
3. Gradleのコマンドラインオプションで設定

1と2は何らかの方法で設定ファイルの内容を動的にしなければ本番環境でもDevelopment modeで起動してしまうので、ややこしいです。

今回は3の方法を採用し、開発環境専用のDockerfile用意し、そのENTRYPOINTでコマンドラインオプションを指定してKtorを起動することにしました。

## Auto-reloadを機能させる


