---
title: "実用性を考えたKtorのホットリロード設定"
emoji: "🔁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ktor", "kotlin", "hotreload"]
published: true
---

# 概要
JVM初心者がKtorを少し触ってみたところ、ホットリロードを機能させるのに苦労したのでそのまとめです。 以下の前提で実用的な設定方法を考えてみました。

- KtorアプリケーションはDockerコンテナで実行される
- ローカル開発環境ではDocker Composeで複数のコンテナを起動する
- 当然ローカル開発環境でのみホットリロードを有効にする

# 結論

- 開発環境用の[Dockerfile.dev](https://github.com/Tomoki108/ktor-sample/blob/main/api/Dockerfile.dev)を用意する 
- その中で「アプリケーションの継続的なビルド」「Development modeでのアプリケーションの継続的な実行」を行う
  ```Dockerfile
  ENTRYPOINT ["bash", "-c", "./gradlew -t build & ./gradlew run -t -Dio.ktor.development=true"]
  ```
- compose.ymlでDockerfile.devを指定してサービスを起動する

## レポジトリ
https://github.com/Tomoki108/ktor-sample

`docker compose up`でアプリを起動します。`localhost:8080`にアクセスするとhello worldが表示されます。

`api/src/main/kotlin/com/example/Routing.kt`でAPIのコードを編集することで、ホットリロードが機能していることを確認できます。

# 解説

## Development mode
Ktorを[Development mode](https://ktor.io/docs/server-development-mode.html)で起動する必要があり、リンクに記載の通り3つの方法があります。

1. Ktorの設定ファイル（application.conf || application.yaml）で設定
2. Gradleの設定ファイル（build.gradle.kts）で設定
3. Gradleのコマンドラインオプションで設定

1と2の方法は、何らかの方法で設定ファイルの内容を動的にしなければ本番環境でもDevelopment modeで起動してしまうのでややこしいです。

今回は3の方法を採用し、開発環境専用のDockerfileを用意しその中でコマンドラインオプションを指定してKtorを起動することにしました。

:::message
開発環境と本番環境でイメージが乖離しないように気をつけて保守する必要があります。Dockerfileは一つにして開発環境用のステージを用意する方法も考えましたが、ややこしいので辞めました。
:::

## ホットリロードを機能させる

Ktorには[Auto-reload](https://ktor.io/docs/server-development-mode.html#system-property)という機能がありますが、**これは一般的なホットリロードではありません。**

ビルドされた`.class`ファイルを監視し、実行中のアプリケーションに即座に反映するというものです。**ソースコードそのものを変更しても実行中のアプリケーションには反映されせん。**

なのでホットリロードを機能させるには、上記ドキュメントに記載の`./gradlew run -t -Dio.ktor.development=true`とは別に`./gradlew -t build`も実行して、同時に継続的ビルドも行う必要があります。

```sh
./gradlew -t build & ./gradlew run -t -Dio.ktor.development=true
```
:::message
  - `-t`オプションは`--continuous`のショートハンドで、特定のリソースを継続的に監視して変化があればコマンドを実行し直す。
  - Gradleでは`-D{key}={value}`の形式でオプションを指定すると、アプリケケーションのランタイムの環境変数を設定できる。-P{key}={value}だとビルドスクリプトでのみ有効な環境変数を設定できる。（[document](https://chatgpt.com/c/6889eabb-4dbc-8328-9c0d-b0733f1caec1)）
:::

# おわりに
「Auto-reload ≠ ホットリロード」ということに気づくのに時間がかかりはまりました。

他には本筋ではないですが、VS Codeからライブラリのソースコードに定義ジャンプできないという問題にもはまりました。こちらは結局解決できず、IntelliJ（無料版）に乗り換えたらすぐ解消しました。JVM書く場合はIntelliJの方が無難そうですね。。




