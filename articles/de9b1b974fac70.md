---
title: "混沌としたGoのエラーハンドリングを改善する"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Go"]
publication_name: "castingone_dev"
published: true
---

こんにちは、バックエンドエンジニアの永田です。今回は CastingONE のバックエンドにおいて、Go のエラーハンドリングの改善に取り組んだ話しをします。

非推奨のパッケージを使っていたり、エラーにスタックトレースがついていないことがあるなど、元々混沌とした状況でした。同じような状況を抱えているプロジェクトもあるかと思うので、何らか参考になれば幸いです。

## 改善前の状況

- エラーにスタックトレースをつけるためのパッケージとして [github.com/pkg/errors](https://github.com/pkg/errors) と [golang.org/x/xerrors](https://pkg.go.dev/golang.org/x/xerrors) の二つが導入されており、混在している。しかも両方現在は非推奨。[^1]

- 標準パッケージの `errors.New()` と `fmt.Errorf()` 関数を利用している箇所があり、それらを起点とするエラーにスタックトレースがついていないことがある。

## 改善後の状況

- エラーハンドリングを行う際には必ず独自のラッパーパッケージを使うようにし、それ以外の方法でエラーハンドリングを行うと github actions で警告が出るようにした。これにより、エラーに必ずスタックトレースがつくようにした。

- 今後スタックトレースについて乗り換えたいパッケージが見つかったり標準エラーパッケージの拡張が起きたときに、ラッパーパッケージだけ修正すれば済むようになった。

## 改善の手順

1. `x/xerrors` の利用箇所を `errors.New()` と `fmt.Errorf()` 関数に置換し、プロジェクトの依存関係から `x/xerrors` を削除する。

2. `pkg/errors` のラッパーを実装する。

3. AST を用いて `pkg/errors`と`errors.New()`、`fmt.Errorf()` をラッパーの関数に置き換えるプログラムを実装し、実行する。

4. `pkg/errors` のインポート及び `errors.New()`と`fmt.Errorf()`の利用に警告を出すための github actions を実装し導入する。

### 1. `x/xerrors` の除去

`x/xerrors` は、Go 1.13 で標準ライブラリに導入されたエラー処理機能のベースとなったパッケージです。バージョンが進んだ現在も使っているのはおかしいので、利用箇所を標準パッケージの`errors.New()`と`fmt.Errorf()`に置換します。

一旦スタックトレースがつかなくなってしまいますが、後の手順によって再度つけています。

### 2. `pkg/errors` のラッパーの実装

基本的には pkg/errors の関数をラップしているだけです。`pkg/errors.Errorf()`のみそのままでは`fmt.Errorf()`と互換性がないため、少し工夫しています。

:::details code

```go
package error

// msgからトレース付きerrorを生成する
func New(msg string) error {
    return pkgerrors.New(msg)
}

// format文からトレース付きerrorを生成する
func Errorf(format string, args ...interface{}) error {
    // pkgerrors.Errorf()は%wに対応していないため、直接wrapせず以下のようにしてある。
    err := fmt.Errorf(format, args...)
    return pkgerrors.WithStack(err)
}

// errorにトレースをつける
func WithStack(err error) error {
    return pkgerrors.WithStack(err)
}

// errのメッセージをmsgでラップし、トレースも付与する
func Wrap(err error, msg string) error {
    return pkgerrors.Wrap(err, msg)
}

// errのメッセージをフォーマット文でラップし、トレースも付与する
func Wrapf(err error, format string, args ...interface{}) error {
    return pkgerrors.Wrapf(err, format, args...)
}

// errのメッセージをmsgでラップする. トレースは付与しない
func WithMessage(err error, message string) error {
    return pkgerrors.WithMessage(err, message)
}

// errのメッセージをフォーマット文でラップする. トレースは付与しない
func WithMessagef(err error, format string, args ...interface{}) error {
    return pkgerrors.WithMessagef(err, message)
}
```

:::

### 3. AST を用いて`pkg/errors`の利用箇所と `errors.New()`、`fmt.Errorf()` をラッパーの関数に置き換える

[^1]: `pkg/errors` や `x/xerrors` が誕生した背景、なぜ現在は非推奨なのか等々については複雑な歴史があるわけですが、ここでは触れません。
