---
title: "æ··æ²Œã¨ã—ãŸGoã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„ã™ã‚‹"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go"]
publication_name: "castingone_dev"
published: true
---

ã“ã‚“ã«ã¡ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ°¸ç”°ã§ã™ã€‚ä»Šå›ã¯ CastingONE ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ãŠã„ã¦ã€Go ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ã«å–ã‚Šçµ„ã‚“ã è©±ã—ã‚’ã—ã¾ã™ã€‚

éæ¨å¥¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã„ãŸã‚Šã€ã‚¨ãƒ©ãƒ¼ã«ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒã¤ã„ã¦ã„ãªã„ã“ã¨ãŒã‚ã‚‹ãªã©ã€å…ƒã€…æ··æ²Œã¨ã—ãŸçŠ¶æ³ã§ã—ãŸã€‚åŒã˜ã‚ˆã†ãªçŠ¶æ³ã‚’æŠ±ãˆã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚ã‚ã‚‹ã‹ã¨æ€ã†ã®ã§ã€ä½•ã‚‰ã‹å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

## Before

- ã‚¨ãƒ©ãƒ¼ã«ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ã¤ã‘ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ [github.com/pkg/errors](https://github.com/pkg/errors) ã¨ [golang.org/x/xerrors](https://pkg.go.dev/golang.org/x/xerrors) ã®äºŒã¤ãŒå°å…¥ã•ã‚Œã¦ãŠã‚Šã€æ··åœ¨ã—ã¦ã„ã‚‹ã€‚ã—ã‹ã‚‚ä¸¡æ–¹ç¾åœ¨ã¯éæ¨å¥¨ã€‚[^1]

- æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`errors.New()`ã¨`fmt.Errorf()`é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Šã€ãã‚Œã‚‰ã‚’èµ·ç‚¹ã¨ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã«ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒã¤ã„ã¦ã„ãªã„ã“ã¨ãŒã‚ã‚‹ã€‚

## After

- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã†éš›ã«ã¯å¿…ãšç‹¬è‡ªã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸(`pkg/errors`ã®ãƒ©ãƒƒãƒ‘ãƒ¼)ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã€ãã‚Œä»¥å¤–ã®æ–¹æ³•ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã†ã¨ github actions ã§è­¦å‘ŠãŒå‡ºã‚‹ã‚ˆã†ã«ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ã«å¿…ãšã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒã¤ãã‚ˆã†ã«ã—ãŸã€‚

- ä»Šå¾Œã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã«ã¤ã„ã¦ä¹—ã‚Šæ›ãˆãŸã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã£ãŸã‚Šæ¨™æº–ã‚¨ãƒ©ãƒ¼ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ‹¡å¼µãŒèµ·ããŸã¨ãã«ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã ã‘ä¿®æ­£ã™ã‚Œã°æ¸ˆã‚€ã‚ˆã†ã«ãªã£ãŸã€‚

## æ”¹å–„ã®æ‰‹é †

1. `x/xerrors`ã®åˆ©ç”¨ç®‡æ‰€ã‚’`errors.New()`ã¨`fmt.Errorf()`é–¢æ•°ã«ç½®æ›ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‹ã‚‰`x/xerrors`ã‚’å‰Šé™¤ã™ã‚‹ã€‚

2. `pkg/errors`ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã€‚

3. AST ã‚’ç”¨ã„ã¦`pkg/errors`ã¨`errors.New()`ã€`fmt.Errorf()`ã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã®é–¢æ•°ã«ç½®ãæ›ãˆã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè£…ã—ã€å®Ÿè¡Œã™ã‚‹ã€‚

4. `pkg/errors`ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆåŠã³`errors.New()`ã¨`fmt.Errorf()`ã®åˆ©ç”¨ã«è­¦å‘Šã‚’å‡ºã™ãŸã‚ã® github actions ã‚’å®Ÿè£…ã—å°å…¥ã™ã‚‹ã€‚

### 1.`x/xerrors`ã®é™¤å»

`x/xerrors`ã¯ã€Go 1.13 ã§æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å°å…¥ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼å‡¦ç†æ©Ÿèƒ½ã®ãƒ™ãƒ¼ã‚¹ã¨ãªã£ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒé€²ã‚“ã ç¾åœ¨ã‚‚ä½¿ã£ã¦ã„ã‚‹ã®ã¯ãŠã‹ã—ã„ã®ã§ã€åˆ©ç”¨ç®‡æ‰€ã‚’æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`errors.New()`ã¨`fmt.Errorf()`ã«ç½®æ›ã—ã¾ã™ã€‚

ä¸€æ—¦ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒã¤ã‹ãªããªã£ã¦ã—ã¾ã„ã¾ã™ãŒã€å¾Œã®æ‰‹é †ã«ã‚ˆã£ã¦å†åº¦ã¤ã‘ã¦ã„ã¾ã™ã€‚

### 2.`pkg/errors`ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã®å®Ÿè£…

åŸºæœ¬çš„ã«ã¯`pkg/errors`ã®é–¢æ•°ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚`pkg/errors.Errorf()`ã®ã¿ãã®ã¾ã¾ã§ã¯`fmt.Errorf()`ã¨äº’æ›æ€§ãŒãªã„ãŸã‚ã€å°‘ã—å·¥å¤«ã—ã¦ã„ã¾ã™ã€‚

:::details code

```go
package error

import (
	"fmt"
	pkgerrors "github.com/pkg/errors"
)

// msgã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ä»˜ãerrorã‚’ç”Ÿæˆã™ã‚‹
func New(msg string) error {
    return pkgerrors.New(msg)
}

// formatæ–‡ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ä»˜ãerrorã‚’ç”Ÿæˆã™ã‚‹
func Errorf(format string, args ...interface{}) error {
    // pkgerrors.Errorf()ã¯%wã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã€ç›´æ¥wrapã›ãšä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã‚ã‚‹ã€‚
    err := fmt.Errorf(format, args...)
    return pkgerrors.WithStack(err)
}

// errorã«ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ã¤ã‘ã‚‹
func WithStack(err error) error {
    return pkgerrors.WithStack(err)
}

// errã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’msgã§ãƒ©ãƒƒãƒ—ã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚‚ä»˜ä¸ã™ã‚‹
func Wrap(err error, msg string) error {
    return pkgerrors.Wrap(err, msg)
}

// errã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡ã§ãƒ©ãƒƒãƒ—ã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚‚ä»˜ä¸ã™ã‚‹
func Wrapf(err error, format string, args ...interface{}) error {
    return pkgerrors.Wrapf(err, format, args...)
}

// errã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’msgã§ãƒ©ãƒƒãƒ—ã™ã‚‹. ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ä»˜ä¸ã—ãªã„
func WithMessage(err error, message string) error {
    return pkgerrors.WithMessage(err, message)
}

// errã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡ã§ãƒ©ãƒƒãƒ—ã™ã‚‹. ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ä»˜ä¸ã—ãªã„
func WithMessagef(err error, format string, args ...interface{}) error {
    return pkgerrors.WithMessagef(err, message)
}
```

:::

### 3. AST ã‚’ç”¨ã„ã¦`pkg/errors`ã®åˆ©ç”¨ç®‡æ‰€ã¨`errors.New()`ã€`fmt.Errorf()`ã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã®é–¢æ•°ã«ç½®ãæ›ãˆã‚‹

ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã§ã¯å¯¾å¿œã—ãã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šæ‰‹å‹•ã§ç½®ãæ›ãˆãŸå ´æ‰€ãŒã‚ã£ãŸã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®äº‹æƒ…[^2]ã‚‚è€ƒæ…®ã—ã¦ã„ã‚‹ã®ã§ã€ã‚ãã¾ã§å‚è€ƒç¨‹åº¦ã«ãªã‚Šã¾ã™ã€‚

:::details code

```go
package main

import (
	"bytes"
	"fmt"
	"go/ast"
	"go/format"
	"go/parser"
	"go/token"
	"log"
	"os"
	"path/filepath"
	"strings"
)

const (
	replacementPkg   = "github.com/CastingONE/castingone/go/pkg/error" // ç½®ãæ›ãˆå¾Œã®é–¢æ•°ã®å±ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
	replacementAlias = "pkgerror"                                      // å›ºå®šã™ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹å
)

func main() {
	rootDir := "../../../../go" // å†å¸°çš„ã«æ¢ç´¢ã™ã‚‹ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

	// å†å¸°çš„ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ­©ã„ã¦Goãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã™ã‚‹
	err := filepath.WalkDir(rootDir, func(path string, d os.DirEntry, err error) error {
		if err != nil {
			return err
		}

		// Goãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’å¯¾è±¡ã¨ã™ã‚‹
		if !d.IsDir() && strings.HasSuffix(path, ".go") {
			fmt.Printf("Processing file: %s\n", path)
			if err := processFile(path); err != nil {
				return fmt.Errorf("failed to process file %s: %w", path, err)
			}
		}
		return nil
	})

	if err != nil {
		log.Fatalf("Error walking the path: %v\n", err)
	}
	fmt.Println("å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚")
}

// Goãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã™ã‚‹å‡¦ç†
func processFile(filePath string) error {
	fset := token.NewFileSet()

	// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒ¼ã‚¹
	file, err := parser.ParseFile(fset, filePath, nil, parser.ParseComments)
	if err != nil {
		return fmt.Errorf("failed to parse file: %w", err)
	}

	// ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
	importMap := make(map[string]string)
	importExists := false
	var importDecl *ast.GenDecl // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã®ä½ç½®ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®å¤‰æ•°
	replaceOccurred := false    // ç½®ãæ›ãˆãŒè¡Œã‚ã‚ŒãŸã‹ã©ã†ã‹ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°

	for _, decl := range file.Decls {
		if genDecl, ok := decl.(*ast.GenDecl); ok && genDecl.Tok == token.IMPORT {
			importDecl = genDecl
			for _, spec := range genDecl.Specs {
				if importSpec, ok := spec.(*ast.ImportSpec); ok {
					pkgPath := strings.Trim(importSpec.Path.Value, "\"")
					alias := ""
					if importSpec.Name != nil {
						alias = importSpec.Name.Name
					} else {
						// ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’æ¨å®š
						parts := strings.Split(pkgPath, "/")
						alias = parts[len(parts)-1]
					}

					importMap[alias] = pkgPath

					// ã™ã§ã«ç½®ãæ›ãˆå¯¾è±¡ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’"pkgerror"ã«å¤‰æ›´
					if pkgPath == replacementPkg {
						importSpec.Name = ast.NewIdent(replacementAlias)
						importExists = true
					}
				}
			}
		}
	}

	// é–¢æ•°å‘¼ã³å‡ºã—ã®ç½®ãæ›ãˆ
	ast.Inspect(file, func(n ast.Node) bool {
		if callExpr, ok := n.(*ast.CallExpr); ok {
			if selExpr, ok := callExpr.Fun.(*ast.SelectorExpr); ok {
				if ident, ok := selExpr.X.(*ast.Ident); ok {
					pkgPath, exists := importMap[ident.Name]

					// "github.com/pkg/errors"ã®é–¢æ•°ç½®ãæ›ãˆ
					if exists && pkgPath == "github.com/pkg/errors" {
						ident.Name = replacementAlias
						replaceOccurred = true
					}

					// "errors.New()"ã®ç½®ãæ›ãˆ
					if exists && pkgPath == "errors" && selExpr.Sel.Name == "New" {
						ident.Name = replacementAlias
						replaceOccurred = true
					}

					// "fmt.Errorf()"ã®ç½®ãæ›ãˆ
					if exists && pkgPath == "fmt" && selExpr.Sel.Name == "Errorf" {
						ident.Name = replacementAlias
						replaceOccurred = true
					}
				}
			}
		}
		return true
	})

	// ç½®ãæ›ãˆãŒè¡Œã‚ã‚ŒãŸå ´åˆã«ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚’è¿½åŠ 
	if replaceOccurred && !importExists {
		newImport := &ast.ImportSpec{
			Name: ast.NewIdent(replacementAlias),
			Path: &ast.BasicLit{
				Value: fmt.Sprintf("\"%s\"", replacementPkg),
			},
		}

		// ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ãŒã‚ã‚‹å ´åˆã¯ãã®ä½ç½®ã«è¿½åŠ ã€ãªã„å ´åˆã¯æ–°ã—ãä½œæˆ
		if importDecl != nil {
			importDecl.Specs = append(importDecl.Specs, newImport)
		} else {
			// æ–°ã—ãã‚¤ãƒ³ãƒãƒ¼ãƒˆå®£è¨€ã‚’ä½œæˆ
			newGenDecl := &ast.GenDecl{
				Tok:   token.IMPORT,
				Specs: []ast.Spec{newImport},
			}
			// æ–°ã—ã„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æœ€åˆã«è¿½åŠ 
			file.Decls = append([]ast.Decl{newGenDecl}, file.Decls...)
		}
	}

	// ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãƒãƒƒãƒ•ã‚¡ã«æ›¸ãè¾¼ã‚€
	var buf bytes.Buffer
	if err := format.Node(&buf, fset, file); err != nil {
		return fmt.Errorf("failed to format file: %w", err)
	}

	// ç½®ãæ›ãˆå¾Œã®å†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãæˆ»ã™
	if err := os.WriteFile(filePath, buf.Bytes(), 0644); err != nil {
		return fmt.Errorf("failed to write file: %w", err)
	}

	return nil
}
```

:::

[^1]: `pkg/errors`ã‚„`x/xerrors`ãŒèª•ç”Ÿã—ãŸèƒŒæ™¯ã€ãªãœç¾åœ¨ã¯éæ¨å¥¨ãªã®ã‹ç­‰ã€…ã«ã¤ã„ã¦ã¯è¤‡é›‘ãªæ­´å²ãŒã‚ã‚‹ã‚ã‘ã§ã™ãŒã€ã“ã“ã§ã¯è§¦ã‚Œã¾ã›ã‚“ã€‚
[^2]: ãƒ©ãƒƒãƒ‘ãƒ¼ã¯`github.com/CastingONE/castingone/go/pkg/error`ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«é…ç½®ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è‡ªä½“ã¯ä»¥å‰ã‹ã‚‰å­˜åœ¨ã—ã¦ãŠã‚Šã€ã•ã¾ã–ã¾ãªå ´æ‰€ã§å‚ç…§ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ãã®ãŸã‚ã€ç½®ãæ›ãˆã‚’è¡Œã£ãŸå¾Œã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚’è¿½åŠ ã™ã¹ãã‚±ãƒ¼ã‚¹ã¨è¿½åŠ ã™ã¹ãã§ã¯ãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚
