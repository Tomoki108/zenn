---
title: "CodecovのSelf Hosted版を（物凄く苦労して）セットアップしました"
emoji: "🐡"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["codecov"]
published: true
---

こんにちは、バックエンドエンジニアの永田です。

以前、コードカバレッジの可視化ツールである[Codecov を導入した話](https://zenn.dev/castingone_dev/articles/d73e1744ca2f9a)を投稿しましたが、今回は有料版ではなく [Self Hosted 版（OSS 版）](https://github.com/codecov/self-hosted)をセットアップした話をしようと思います。

情報が非常に少なく苦労したので、誰かの参考になれば幸いです。今回はインフラ基盤として Google Cloud を使用し、terraform で管理しています。

# インフラ構成

単一の GCE のインスタンス上で、 docker によって codecov を構成する複数サービスのコンテナを起動しています。
ポートマッピングによって GCE インスタンスへのリクエストを gateway コンテナに送り、そこから各サービスへリクエストが振り分けられます。
ちなみに codecov の各サービスの定義は以下のとおりです。

- gateway：BFF やロードバランサーの様なもの
- api：api
- worker：カバレッジレポートの処理などを行う worker
- frontend：codecov のコンソール画面
- redis：キャッシュ
- postgres：DB
- timescale：カバレッジの時系列データ専用の DB

※ 構成図は特にネットワーク周りなど雑ですが、概要の参考程度に見て頂ければ。

![codecov_architecture](/images/202411_codecov_sh/codecov_architecture.drawio.png)

## 構成のポイント

### アプリケーションの基盤は基本的に GCE

[こちらの公式の記事](https://codecoventerprise.codecov.io/hc/en-us/articles/15812821581083-Self-Hosted-Deployment-Strategies)でデプロイ戦略が 3 つ紹介されているのですが、最も簡単な、単一のサーバーで docker compose を利用し複数サービスのコンテナを動かす方式を取りました。

[こちらのレポジトリ](https://github.com/codecov/self-hosted/tree/main)を見ると分かりますが、codecov は 8 つのサービスから構成されています。それぞれを単一のサーバーにデプロイするのが理想なのですが、そうしてしまうとメンテナンスコスト、クラウドの料金が莫大になってしまい、Self Hosted 版を使う旨みが全くなくなってしまうからです。

DB についても GCE 内のコンテナとして起動し、外部ディスクを GCE インスタンスに紐づけることでデータが消えない様にしています。Alloy DB や Cloud SQL の料金はとても高いので、使った瞬間 codecov の有料版の料金を超えてしまいます。

カバレッジレポート用のファイルストレージのみ、料金が安かっため GCS に外部化しています。

### GCE のスポットインスタンスを Instance Group で管理

GCE は料金を抑えるため、スポットインスタンス（preemptible instance）を利用しています。

スポットインスタンスが停止した際に新たなインスタンスを起動するためと、コスト削減のためにインスタンスの起動を営業時間内のみにするために、Instance Group を利用しています。terraform は以下の通りです。

```terraform


```

## コストはどのくらい？

## ハマったこと

### HTTPS 対応
